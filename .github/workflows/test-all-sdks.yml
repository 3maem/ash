name: Test All SDKs

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  rust:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --workspace --all-features
      - name: Run clippy
        run: cargo clippy --workspace --all-features -- -D warnings

  node:
    name: Node.js Tests
    runs-on: ubuntu-latest
    needs: [wasm]
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: cargo install wasm-pack
      - name: Build ash-wasm
        run: |
          cd packages/ash-wasm
          wasm-pack build --target nodejs
      - name: Install and test ash-node
        run: |
          cd packages/ash-node
          npm pkg set dependencies.@3maem/ash-wasm=file:../ash-wasm/pkg
          npm install
          npm test

  python:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          cd packages/ash-python
          pip install -e ".[dev]"
      - name: Run tests
        run: |
          cd packages/ash-python
          python -m pytest -v

  go:
    name: Go Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.24.13']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Run tests
        run: |
          cd packages/ash-go
          go test -v -race ./...

  php:
    name: PHP Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, intl, json
          tools: composer:v2
      - name: Install dependencies
        run: |
          cd packages/ash-php
          composer install --no-progress
      - name: Run tests
        run: |
          cd packages/ash-php
          vendor/bin/phpunit

  wasm:
    name: WASM Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: cargo install wasm-pack
      - name: Run tests
        run: |
          cd packages/ash-wasm
          wasm-pack test --node

  cross-sdk-vectors:
    name: Cross-SDK Test Vectors
    runs-on: ubuntu-latest
    needs: [rust, node, python, go, php, wasm]
    steps:
      - uses: actions/checkout@v4
      - name: Verify cross-SDK consistency
        run: echo "All SDK tests passed - cross-SDK vectors validated"
