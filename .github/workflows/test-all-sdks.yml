name: Test All SDKs

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  rust:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --workspace --all-features
      - name: Run clippy
        run: cargo clippy --workspace --all-features -- -D warnings

  node:
    name: Node.js Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm test -w packages/ash-node

  python:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          cd packages/ash-python
          pip install -e ".[dev]"
      - name: Run tests
        run: |
          cd packages/ash-python
          python -m pytest -v

  go:
    name: Go Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22', '1.23']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Run tests
        run: |
          cd packages/ash-go
          go test -v -race ./...

  php:
    name: PHP Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, intl, json
          tools: composer:v2
      - name: Install dependencies
        run: |
          cd packages/ash-php
          composer install --no-progress
      - name: Run tests
        run: |
          cd packages/ash-php
          vendor/bin/phpunit

  dotnet:
    name: .NET Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['6.0', '7.0', '8.0']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
      - name: Run tests
        run: |
          cd packages/ash-dotnet
          dotnet test --verbosity normal

  security-assurance:
    name: Security Assurance Pack
    runs-on: ubuntu-latest
    needs: [python]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install dependencies
        run: |
          cd packages/ash-python
          pip install -e ".[dev]"
          pip install pytest-asyncio
      - name: Run Security Assurance Pack
        run: |
          python -m pytest tests/security_assurance/ -v

  cross-sdk-vectors:
    name: Cross-SDK Test Vectors
    runs-on: ubuntu-latest
    needs: [rust, node, python, go, php, dotnet]
    steps:
      - uses: actions/checkout@v4
      - name: Verify cross-SDK consistency
        run: echo "All SDK tests passed - cross-SDK vectors validated"
