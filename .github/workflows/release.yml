name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: ASH ${{ github.ref_name }}
          body: |
            ## ASH ${{ github.ref_name }}

            **Ash was developed by 3maem Co. | شركة عمائم**

            ### Packages

            | Package | Registry |
            |---------|----------|
            | `ash-core` | crates.io |
            | `@3maem/ash-node` | npm |
            | `ash-sdk` | PyPI |
            | `3maem/ash-sdk-php` | Packagist |
            | `github.com/3maem/ash-go/v2` | Go Modules |
            | `@3maem/ash-wasm` | npm |

            ### Installation

            **Node.js:**
            ```bash
            npm install @3maem/ash-node
            ```

            **Python:**
            ```bash
            pip install ash-sdk
            ```

            **PHP:**
            ```bash
            composer require 3maem/ash-sdk-php
            ```

            **Go:**
            ```bash
            go get github.com/3maem/ash-go/v2
            ```

            **WASM (Browser/Node.js):**
            ```bash
            npm install @3maem/ash-wasm
            ```

            See CHANGELOG.md for detailed changes.
          draft: false
          prerelease: false

  publish-rust:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish ash-core
        run: cargo publish --package ash-core --token ${{ secrets.CRATES_IO_TOKEN }}

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install and build
        run: |
          npm ci
          npm run build

      - name: Publish
        run: npm publish --workspace=packages/ash-node --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        working-directory: packages/ash-python
        run: python -m build

      - name: Publish to PyPI
        working-directory: packages/ash-python
        run: twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  publish-packagist:
    name: Publish to Packagist
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Trigger Packagist update
        run: |
          curl -X POST "https://packagist.org/api/update-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
            -d "repository[url]=https://github.com/3maem/ash"

  publish-wasm:
    name: Publish WASM to npm
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM package
        working-directory: packages/ash-wasm
        run: wasm-pack build --target bundler

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish to npm
        working-directory: packages/ash-wasm/pkg
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
