# Migration Guide: v2.3.3 to v2.3.4

This guide covers the breaking changes and required updates when upgrading from ASH SDK v2.3.3 to v2.3.4.

---

## Breaking Changes

### HTTP Status Codes

v2.3.4 introduces unique HTTP status codes (450-483 range) for ASH-specific errors. This is a **breaking change** for clients that handle specific error codes.

| Error | Old Status | New Status |
|-------|------------|------------|
| Context not found | 404 | 450 |
| Context expired | 401 | 451 |
| Replay detected | 409 | 452 |
| Proof invalid | 401 | 460 |
| Binding mismatch | 403 | 461 |
| Scope mismatch | 403 | 473 |
| Chain broken | 403 | 474 |
| Timestamp invalid | 400 | 482 |
| Proof missing | 401 | 483 |

**Why this change?**
- Standard HTTP codes conflicted with other application errors
- New codes enable precise error identification and monitoring
- Better retry logic (e.g., retry on 451 expired but not on 460 invalid)

---

## Client Updates Required

### JavaScript/TypeScript

```javascript
// Before (v2.3.3)
if (response.status === 404) {
  // Context not found
} else if (response.status === 401) {
  // Could be expired OR invalid proof - ambiguous
}

// After (v2.3.4)
if (response.status === 450) {
  // Context not found - request new context
} else if (response.status === 451) {
  // Context expired - request new context
} else if (response.status === 452) {
  // Replay detected - request new context
} else if (response.status === 460) {
  // Proof invalid - check implementation
}
```

### Python

```python
# Before (v2.3.3)
if response.status_code == 404:
    # Context not found

# After (v2.3.4)
if response.status_code == 450:
    # Context not found
elif response.status_code == 451:
    # Context expired
elif response.status_code == 452:
    # Replay detected
```

### Go

```go
// Before (v2.3.3)
if resp.StatusCode == http.StatusNotFound {
    // Context not found
}

// After (v2.3.4)
const (
    AshCtxNotFound    = 450
    AshCtxExpired     = 451
    AshReplayDetected = 452
    AshProofInvalid   = 460
)

if resp.StatusCode == AshCtxNotFound {
    // Context not found
}
```

### PHP

```php
// Before (v2.3.3)
if ($response->getStatusCode() === 404) {
    // Context not found
}

// After (v2.3.4)
if ($response->getStatusCode() === 450) {
    // Context not found
} elseif ($response->getStatusCode() === 451) {
    // Context expired
}
```

---

## Environment Variables (New)

v2.3.4 adds environment-based configuration. No migration required, but you can now configure:

```bash
# Production deployment
ASH_TRUST_PROXY=true
ASH_TRUSTED_PROXIES=10.0.0.1,10.0.0.2
ASH_TIMESTAMP_TOLERANCE=30
ASH_RATE_LIMIT_WINDOW=60
ASH_RATE_LIMIT_MAX=10
```

---

## Upgrade Steps

1. **Update package**
   ```bash
   # Node.js
   npm install @3maem/ash-node@2.3.4

   # Python
   pip install ash-sdk==2.3.4

   # Go
   go get github.com/3maem/ash-go/v2@v2.3.4

   # PHP
   composer require 3maem/ash-sdk-php:^2.3.4
   ```

2. **Update error handling** - Replace old HTTP status codes with new ASH-specific codes

3. **Test thoroughly** - Run cross-SDK test vectors to verify compatibility

4. **Configure environment** (optional) - Set environment variables for production

5. **Enable IP/user binding** (optional) - Add `enforceIp: true` if needed

---

## Backward Compatibility

The server middleware will return the new status codes. Ensure all clients are updated before deploying v2.3.4 to production.

If you need a gradual rollout, you can temporarily map new codes back to old codes in a proxy layer, but this is not recommended for production.

---

## Questions?

- [Release Notes](../releases/2.3.4.md)
- [Full Changelog](../../CHANGELOG.md)
- [Security Policy](../../SECURITY.md)
